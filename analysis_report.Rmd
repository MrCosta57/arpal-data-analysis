---
title: "Assessing Air Quality in Lombardia, Italy through Time Series Analysis: Implications for Public Health and Policy"
subtitle: "Time Searies Analysis project"
author: "Giovanni Costa - 880892"
date: "AY 2023/24"
geometry: "left=1cm,right=2cm,top=1cm,bottom=1cm"
output:
  html_document:
    toc: true
    number_sections: true
    toc_depth: 2
    toc_float:
      smooth_scroll: false
    fig_caption: yes
    theme: flatly
    highlight: pygments
    css: "assets/css/styles.css"
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include=TRUE)
knitr::opts_chunk$set(echo=FALSE)
knitr::opts_chunk$set(fig.align='center')
```

```{r environment setup, include=FALSE}
rm(list=ls())
Sys.setlocale("LC_TIME", "en_US.UTF-8")
```


# Introduction
This project aims to evaluate the air quality in Lombardia, Italy, using a comprehensive time series analysis. The data for this study will be derived from sensors located at various stations across the region, which can be accessed via the regional website.

The primary focus is to underscore the significance of air quality on public health. By analyzing the trends and patterns in air quality data over time, it's possible to identify periods of high pollution and correlate these with potential health risks. This analysis will provide valuable insights into how air quality fluctuations may impact the respiratory health of the region's inhabitants.


# Prerequirements
```{r results='hide', message=FALSE, warning=FALSE}
set.seed(123) # set pseudorandom generator for reprocucibility

# Load all the packages and install them if they are not present
#default_colors <- palette.colors()[2:length(palette.colors())] #exclude black color
requirements <- c("ARPALData", "xts", "forecast", "TSA")

for (library_name in requirements) {
  if (!require(library_name, character.only = TRUE)) {
    install.packages(library_name, repos = "https://cloud.r-project.org")
    library(library_name, character.only = TRUE)
  }
}

# Import user defined functions
source("utils.R")

# library(styler)
# style_file("analysis_report.Rmd")
```

# Data retrieval
```{r results='hide', message=FALSE, warning=FALSE}
start_date <- "2004-01-01"
end_date <- "2023-12-31"
# Milano v.Senato, Bormio v.Monte Braulio, Schivenoglia v. Malpasso
aq_station_ids <- c(548, 571, 703)

df_aq_daily <- NULL
df_w_daily <- NULL
#df_aq_monthly <- NULL
#df_w_monthly <- NULL
#df_aq_yearly <- NULL
#df_w_yearly <- NULL
df_aq_stations <- NULL
df_w_stations <- NULL

if(length(list.files("data/")) == 0) {
  # Air quality data
  df_aq_daily<-get_ARPA_Lombardia_AQ_data(ID_station=aq_station_ids, Date_begin = start_date,
                                          Date_end = end_date, Frequency="daily", parallel = TRUE)
  #df_aq_monthly<-get_ARPA_Lombardia_AQ_data(ID_station=aq_station_ids, Date_begin = start_date,
  #                                        Date_end = end_date, Frequency="monthly", parallel = TRUE)
  #df_aq_yearly<-get_ARPA_Lombardia_AQ_data(ID_station=aq_station_ids, Date_begin = start_date,
  #                                       Date_end = end_date, Frequency="yearly", parallel = TRUE)
  # Station data
  df_aq_stations<-get_ARPA_Lombardia_AQ_registry()
  df_aq_stations<-df_aq_stations[df_aq_stations$IDStation %in% aq_station_ids,]
  df_w_stations<-get_ARPA_Lombardia_W_registry()
  knn_res <- registry_KNN_dist(df_aq_stations, df_w_stations, k=1)
  df_w_stations<-df_w_stations[df_w_stations$IDStation %in% knn_res[[1]]$reg_Y_nn1_ID,]
  
  # Save data
  saveRDS(df_aq_daily, "data/df_aq_daily.rds")
  #saveRDS(df_aq_monthly, "data/df_aq_monthly.rds")
  #saveRDS(df_aq_yearly, "data/df_aq_yearly.rds")
  saveRDS(df_aq_stations, "data/df_aq_stations.rds")
  saveRDS(df_w_stations, "data/df_w_stations.rds")
  saveRDS(knn_res, "data/knn_res.rds")
  
  #TODO download from here
  w_station_ids <- unique(df_w_stations$IDStation)
  df_w_daily<-get_ARPA_Lombardia_W_data(ID_station=w_station_ids, Date_begin = start_date,
                                        Date_end = end_date, Frequency="daily", parallel = TRUE)
  #df_w_monthly<-get_ARPA_Lombardia_W_data(ID_station=w_station_ids, Date_begin = start_date,
  #                                        Date_end = end_date, Frequency="monthly", parallel = TRUE)
  #df_w_yearly<-get_ARPA_Lombardia_W_data(ID_station=w_station_ids, Date_begin = start_date,
  #                                       Date_end = end_date, Frequency="yearly", parallel = TRUE)
  
  # Save data
  saveRDS(df_w_daily, "data/df_w_daily.rds")
  #saveRDS(df_w_monthly, "data/df_w_monthly.rds")
  #saveRDS(df_w_yearly, "data/df_w_yearly.rds")
  
}else{
  df_aq_daily <- readRDS("data/df_aq_daily.rds")
  df_w_daily <- readRDS("data/df_w_daily.rds")
  #df_aq_monthly <- readRDS("data/df_aq_monthly.rds")
  #df_w_monthly <- readRDS("data/df_w_monthly.rds")
  #df_aq_yearly <- readRDS("data/df_aq_yearly.rds")
  #df_w_yearly <- readRDS("data/df_w_yearly.rds")
  df_aq_stations <- readRDS("data/df_aq_stations.rds")
  df_w_stations <- readRDS("data/df_w_stations.rds")
}
```

```{r results='hide', message=FALSE, warning=FALSE}
```

```{r}
# check_missing_dates(df_aq_daily, start_date, end_date, "day")
# check_missing_dates(df_w_daily, start_date, end_date, "day")
# check_missing_dates(df_aq_monthly, start_date, end_date, "month")
# check_missing_dates(df_w_monthly, start_date, end_date, "month")
# check_missing_dates(df_aq_yearly, start_date, end_date, "year")
# check_missing_dates(df_w_yearly, start_date, end_date, "year")
```


```{r results='hide', message=FALSE, warning=FALSE}
get_ARPA_Lombardia_zoning(
  plot_map = TRUE,
  title = "ARPA Lombardia zoning",
  line_type = 1,
  line_size = 1,
  xlab = "Longitude",
  ylab = "Latitude"
)
```

```{r results='hide', message=FALSE, warning=FALSE}
plot_AQ_W_stations(data_aq = df_aq_stations, data_w = df_w_stations, title = "Map of ARPA stations in Lombardy")
```




# Exploratory Data Analysis
```{r}
# ALL DONE AMONGS THE AREAS
# Clean and preprocess the data, handling missing values and outliers as necessary.
# Perform an initial exploration of the data to understand trends, patterns, and relationships between variables (smoothing and decomposition for ex)
# Visualize the data using plots such as time series, scatter plots, and histograms.
# Calculate summary statistics for air pollutants and meteorological variables.
```
```{r}
tmp <- xts(df_aq_daily$NO2, order.by = df_aq_daily$Date)
plot(xts(df_aq_yearly[df_aq_yearly$IDStation==548,"PM2.5"],order.by=df_aq_yearly[df_aq_yearly$IDStation==548,]$Date))

plot(xts(df_aq_monthly[df_aq_monthly$IDStation==548,"PM2.5"],order.by=df_aq_monthly[df_aq_monthly$IDStation==548,]$Date))
```

# Data engineering


# Models developement

## Time Searies
```{r}
# ALL DONE AMONGS THE AREAS
# stationarity, ACF, PACF, seasonality etc
# Monthplot
# ARIMA, box jenkins
```

## Dynamic regression
```{r}
# try standart lin regr and multivariate TS analysis

# Correlation Analysis:
# Investigate the relationships between air pollutants and meteorological variables.
# Identify key factors that may contribute to poor air quality in the region.
```

## Non linear models

# Forecasting
```{r}
# Compare models with metrics and with "simpler" forecasting models
```


# Conclusions
```{r}
# Discussion and further perspectives.
# The discussion section should recall the main results and point to new research questions, that appeared from your work, or possible limitations.
```


